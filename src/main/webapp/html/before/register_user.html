<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户注册</title>

    <link rel="stylesheet" href="/videos/static/layui/css/layui.css">
    <link rel="stylesheet" href="/videos/static/city-picker/city-picker.css">
    <script src="/videos/static/js/jquery-3.4.1.min.js"></script>
    <script src="/videos/static/layui/layui.js"></script>
    <script src="/videos/static/city-picker/city-picker.data.js"></script>
    <script src="/videos/static/city-picker/citypicker.js"></script>

    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none;}
        input[type="number"] { -moz-appearance: textfield; }

        #registerForm div.layui-input-inline, input { width: 250px; }
        .register-box {
            margin: 50px auto;
            width: 370px;
        }
        #imgUrlDiv {
            height: 116px;
        }
        #imgUrlDiv label {
            display: block;
            height: 100px;
            line-height: 78px;
            text-align: center;
        }
    </style>
</head>
<body class="body">

    <div class="register-box" style="margin-top: 50px">
        <form id="registerForm" class="layui-form layui-form-pane" lay-filter="registerForm" enctype="multipart/form-data">
            <div class="layui-form-item">
                <h1 style="color: #009688; font-weight: bold;text-align: center">用户注册</h1>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="accountInput">账号：</label>
                <div class="layui-input-inline">
                    <input id="accountInput" type="text" name="code" class="layui-input"
                           lay-verify="required|code" placeholder="账号"
                           autocomplete="off" maxlength="20"/>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="emailInput">邮箱：</label>
                <div class="layui-input-inline">
                    <input id="emailInput" type="email" name="email" class="layui-input"
                           lay-verify="required|email" placeholder="邮箱" autocomplete="off"/>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="phoneInput">手机号：</label>
                <div class="layui-input-inline">
                    <input id="phoneInput" type="number" name="phoneNum" class="layui-input" autocomplete="off"
                           lay-verify="required|phone" placeholder="手机号"/>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="passwordInput1">密码：</label>
                <div class="layui-input-inline">
                    <input id="passwordInput1" type="text" name="password" class="layui-input"
                           lay-verify="required|pass" placeholder="password" autocomplete="off"/>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="passwordInput2">确认密码：</label>
                <div class="layui-input-inline">
                    <input id="passwordInput2" type="password" class="layui-input" name="password2"
                           lay-verify="required|pass" placeholder="再次输入密码" autocomplete="off"/>
                </div>
                <p style="display: none; font-size: 14px; color: red; text-align: center" id="passwordMsg">
                    两次输入的密码不一致</p>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="nickNameInput">昵称：</label>
                <div class="layui-input-inline">
                    <input id="nickNameInput" type="text" name="nickName" class="layui-input"
                           lay-verify="required|nickName" placeholder="昵称" autocomplete="off"/>
                </div>
            </div>
            <div class="layui-form-item" pane="" style="width:357px; height: 38px">
                <label class="layui-form-label">性别：</label>
                <div class="layui-input-inline">
                    <input type="radio" name="sex" value="1" title="男" checked="">
                    <input type="radio" name="sex" value="0" title="女">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="birthdayInput">出生日期：</label>
                <div class="layui-input-inline">
                    <input id="birthdayInput" type="text" class="layui-input" name="birthday"
                           lay-verify="required|date" placeholder="yyyy-MM-dd" autocomplete="off">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="city-picker">省市县：</label>
                <div class="layui-input-inline">
                    <input type="text" autocomplete="on" class="layui-input" id="city-picker"
                           lay-verify="required|cityPicker" readonly="readonly" data-toggle="city-picker"
                           placeholder="请选择">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="addressInput">详细地址：</label>
                <div class="layui-input-inline">
                    <input id="addressInput" type="text" class="layui-input"
                           lay-verify="required|address" autocomplete="off" placeholder="精确到门牌号"/>
                </div>
            </div>
            <input type="hidden" name="address" id="fullAddressInput">

            <div class="layui-form-item" id="imgUrlDiv">
                <label class="layui-form-label">上传头像：</label>
                <div class="layui-input-inline">
                    <div class="layui-upload-drag"
                         style="line-height: 100px;padding: 0 10px; width: 227px; height: 98px" id="imgUrlBtn">
                        <i id="imgMsg" class="layui-icon">
                            <!--                            <p style="font-size: 14px">点我上传</p>-->
                        </i>
                        <img style="display: none;margin: 0 auto;" class="layui-upload-img" id="imgFile" width="100px"
                             height="100px">
                    </div>
                    <input type="file" name="file" id="fileInput" style="display: none">
                    <input type="hidden" name="imgUrl" id="imgUrlInput">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" for="codeInput">验证码：</label>
                <div class="layui-input-inline">
                    <input id="codeInput" type="text" name="captcha" class="layui-input" autocomplete="off"
                           lay-verify="required|captcha" placeholder="验证码" style="width: 95px; float: left;"
                           maxlength="4"/>
                    <img src="/videos/getGifCode" style="display: block; float:right; "
                         title="单击刷新验证码" id="img_captcha" alt="单击刷新验证码">
                </div>
            </div>
            <div class="layui-form-item">
                <button type="reset" class="layui-btn layui-btn-danger btn-reset">重置</button>
                <button type="button" class="layui-btn btn-submit" style="margin-right:20px; float: right"
                        id="registerBtn" lay-submit lay-filter="registerBtn">立即注册
                </button>
                <button type="" style="display: none" id="registerUpload" lay-filter="registerUpload"></button>

            </div>
        </form>
    </div>
    <script>
        // 加载省市县三级联动的插件
        layui.config({
            base: '/videos/static/city-picker/'
        });
        layui.use(['form', 'layer', 'laydate', 'citypicker', 'upload'], function () {
            var $ = layui.jquery,
                form = layui.form,
                layer = layui.layer,
                laydate = layui.laydate,
                cityPicker = layui.citypicker,
                upload = layui.upload;

            var isUpload = false;   // 是否存在需要上传的文件
            var fileValue;          // 文件对象

            // 地区
            var currentPicker = new cityPicker("#city-picker", {
                provinceName: "provinceId",
                cityName: "cityId",
                districtName: "districtId",
                level: 'districtId'     // 级别
            });
            // 日期
            laydate.render({
                elem: '#birthdayInput'
            });
            // 头像上传
            upload.render({
                elem: '#imgUrlBtn'
                , url: '/videos/upload/headImg.do'
                , accept: 'images'    // 允许上传的文件的类型，默认为images
                , auto: false
                // , bindAction: "#registerUpload"
                , choose: function (obj) { // 选择之后立即执行
                    isUpload = true;
                    //预读本地文件示例，不支持ie8
                    obj.preview(function (index, file, result) {
                        $('#imgFile').attr('src', result); //图片链接（base64）
                        fileValue = file;
                        // console.log(fileValue);
                    });
                    $("#imgMsg").css("display", "none");
                    $("#imgFile").css("display", "block");
                }
                , before: function (obj) { // 上传之前执行
                }
                , done: function (res) { // 上传请求成功之后执行
                    if (res.code === 1) { // 上传失败
                        return layer.msg(res.data);
                    }
                }
                , error: function () { // 上传请求失败
                    layer.msg("上传过程中出错啦");
                }
            });

            //自定义验证规则
            form.verify({
                code: [
                    /^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,10}$/
                    ,'账号必须由数字和字母组成，6到12位'
                ],
                email: [
                    /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/
                    , '邮箱格式不正确'
                ],
                pass: [
                    /^[\S]{6,12}$/
                    ,'密码必须6到12位，且不能出现空格'
                    // /^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?([^\w\s]|[_])).{8,}$/
                    // , '密码必须包含大小写字母和数字和特殊字符，且不能出现空格，8~16位'
                ],
                nickName: function(value) {
                    if (value.length > 8) {
                        return '昵称不能超过8个字';
                    }
                },
                cityPicker: [
                    /^([\u4e00-\u9fa5]+)\/([\u4e00-\u9fa5]+)\/([\u4e00-\u9fa5]+)$/
                    , '请选择完整的地址信息'
                ],
                address: function(value) {
                    if (value.length < 5) {
                        return '详细地址不能少于5个字';
                    }
                }
            });
            // 监听提交
            form.on('submit(registerBtn)', function (rel) {
                // 拼接地址
                joinAddress();
                var data = form.val("registerForm");
                console.log(data);
                if (isUpload) {
                    // 有文件的时候
                    uploadForm(data);
                } else {
                    // 没有文件的时候
                    normalForm(data);
                }
                return false;
            });

            // 有文件的时候
            function uploadForm(data) {
                uploadImg(data);
                data = form.val("registerForm");
                console.log(data);
                $.ajax({
                    type: "POST",
                    url: "/videos/user/register.do",
                    async: false,
                    data: data,
                    success: function (result) {
                        // console.log(result);
                        registerSuccess(result);
                    }
                });
            }

            // 没有文件的时候
            function normalForm(data) {
                $.ajax({
                    type: "POST",
                    url: "/videos/user/register.do",
                    data: data,
                    success: function (result) {
                        // console.log(result);
                        registerSuccess(result);
                    }
                });
            }

            // 上传图片
            function uploadImg() {
                var form_data = new FormData();
                form_data.append("file", fileValue);
                $.ajax({
                    type: "POST",
                    url: "/videos/upload/headImg.do",
                    processData: false,
                    contentType: false,
                    async: false,
                    data: form_data,
                    success: function (result) {
                        // console.log(result);
                        $("#imgUrlInput").val(result.data);
                    }
                });
            }

            // 注册之后执行
            function registerSuccess(result) {
                if (result.code === 0) {
                    layer.msg("注册成功！");
                    if (!window.name) {
                        window.location.href = "/videos/html/index.html";
                    } else {
                        var index = parent.layer.getFrameIndex(window.name); // 得到 iframe 的索引
                        parent.layer.close(index);  // 调用父类的页面关闭该页面
                    }
                } else {
                    layer.msg("注册失败：" + result.data);
                }
            }

            // 拼接地址
            function joinAddress() {
                var cityPicker = $("#city-picker").val();
                var address = $("#addressInput").val();
                $("#fullAddressInput").val(cityPicker + '/' + address);
                console.log($("#fullAddressInput").val());
            }

            // 刷新验证码
            $("#img_captcha").click(function () {
                $("#img_captcha").attr("src", "/videos/getGifCode?date=" + new Date().valueOf());
            });
        });

        $(function () {
            $("#passwordInput1").change(function () {
                verifyPassword();
            });
            $("#passwordInput2").change(function () {
                verifyPassword();
            });

            // 验证两次输入密码是否一致
            function verifyPassword() {
                var ps1 = $("#passwordInput1").val();
                var ps2 = $("#passwordInput2").val();
                if (ps1 == ps2) {
                    $("#passwordMsg").css("display", "none");
                    return true;
                } else {
                    $("#passwordMsg").css("display", "block");
                    return false;
                }
            }
        });
    </script>
</body>
</html>